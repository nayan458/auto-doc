#!/bin/bash

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_URL="https://github.com/nayan458/auto-doc.git"
TEMP_DIR="/tmp/auto-doc-$$"

echo "ğŸš€ Git Auto-Documentation Tool"
echo "================================"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Error: Not a git repository"
    exit 1
fi

# Step 1: Create branch
echo ""
echo "ğŸ“ Step 1: Creating branch 'project/doc'..."
if git show-ref --verify --quiet refs/heads/project/doc; then
    echo "âš ï¸  Branch 'project/doc' already exists. Switching to it..."
    git checkout project/doc
else
    git checkout -b project/doc
    echo "âœ… Branch created and checked out"
fi

# Step 2: Clone/pull the frontend repo
echo ""
echo "ğŸ“¦ Step 2: Fetching documentation generator..."
if [ -d "$TEMP_DIR" ]; then
    rm -rf "$TEMP_DIR"
fi

git clone --depth 1 "$REPO_URL" "$TEMP_DIR"
echo "âœ… Documentation tools downloaded"

# Step 3: Copy script to current repo
echo ""
echo "ğŸ“‹ Step 3: Setting up documentation scripts..."
cp "$TEMP_DIR/script.sh" ./
chmod +x ./script.sh
echo "âœ… Scripts ready"

# Step 4: Run the script
echo ""
echo "ğŸ” Step 4: Collecting README files..."
./script.sh

if [ ! -d "collected-readmes" ] || [ ! -f "nav.json" ]; then
    echo "âŒ Error: Script failed to generate required files"
    exit 1
fi
echo "âœ… Documentation collected"

# Step 5: Copy frontend files
echo ""
echo "ğŸ¨ Step 5: Setting up documentation viewer..."
if [ -d "doc-viewer" ]; then
    rm -rf doc-viewer
fi

mkdir -p doc-viewer
cp -r "$TEMP_DIR/frontend/"* doc-viewer/
echo "âœ… Viewer setup complete"

# Step 6: Move files and commit
echo ""
echo "ğŸ’¾ Step 6: Committing documentation..."
mv collected-readmes/ doc-viewer/src/collected-readmes
mv ./nav.json doc-viewer/

# Add all generated files
# git add collected-readmes/
# git add nav.json
git add doc-viewer/
# git add script.sh

# Commit
git commit -m "docs: Generate project documentation

- Collected README files from project
- Generated navigation structure
- Added documentation viewer frontend

Generated by auto-doc
" || echo "âš ï¸  No changes to commit"

# Cleanup
rm -rf "$TEMP_DIR"
rm ./script.sh

echo ""
echo "================================"
echo "âœ… Documentation generation complete!"
echo ""
echo "ğŸ“ Generated files:"
echo "   - collected-readmes/  (All README files)"
echo "   - nav.json           (Navigation structure)"
echo "   - doc-viewer/        (Frontend viewer)"
echo ""
echo "ğŸŒ¿ Branch: project/doc"
echo ""
echo "Next steps:"
echo "  1. Review changes: git status"
echo "  2. Push to remote: git push origin project/doc"
echo "  3. View docs: cd doc-viewer && npm install && npm start"
echo ""

# echo "starting application"
# cd doc-viewer
# pnpm i
# pnpm run dev
